# Display Website Migration Notes

## Summary of Changes

This document outlines the changes made to migrate from the old PNG-based visualization system to the new Plotly HTML-based visualization system from `c3po_display`.

## Key Changes

### 1. Data Source Path Update
- **Old**: `/mnt/vdd/yajit_backups/hca_lung_atlas_files/node_summary_figures/{node_name}/`
- **New**: `/home/ubuntu/c3po_outputs/{node_name}_display_figures/`

### 2. File Format Change: PNG → HTML
All visualizations are now interactive Plotly HTML files instead of static PNG images.

### 3. File Name Mapping

| Old Filename | New Filename | Notes |
|--------------|--------------|-------|
| `umap_cell_type.html` | `umap_by_cell_type.html` | Renamed |
| `cell_type_by_program_activity_heatmap.png` | `heatmap_programs_by_cell_type.html` | PNG → HTML |
| `leiden_cluster_by_program_activity_heatmap.png` | `heatmap_programs_by_leiden.html` | PNG → HTML |
| `cluster_by_cell_type_heatmap.png` | *(not generated)* | Missing - displays "No image found" |
| `cell_type_by_program_activity_program_N.png` | `per_program_heatmaps/program_N_breakdown.html` | Combined into single breakdown |
| `leiden_cluster_by_program_activity_program_N.png` | *(combined above)* | Now part of breakdown HTML |
| `program_N_umap_*.png` | `program_umaps/program_N.html` | In subdirectory now |

### 4. Program Indexing: 0-based → 1-based
- **Old**: Programs numbered as `program_0`, `program_1`, etc.
- **New**: Programs numbered as `program_1`, `program_2`, etc.
- The server now converts from 0-based internal indexing to 1-based file paths

### 5. Backend Changes (`server.py`)

#### New API Endpoint
- Added `/api/node-summary-html/<node_name>/<path:filepath>` to serve HTML files

#### Updated Functions
- `get_node_summary()`: Updated to use new paths and HTML file mappings
- `get_node_programs()`: Updated to convert program indexing (0-based → 1-based)
- `serve_node_summary_image()`: Updated base path
- `serve_interactive_plot()`: Updated to use `umap_by_cell_type.html`

### 6. Frontend Changes (`app.js`)

#### Image Rendering
- Added iframe-based rendering for HTML files
- Fallback "No image found" message for missing visualizations
- Removed PNG image compression logic for HTML files

#### Per-Program Breakdowns
- Updated to display combined breakdown HTML (cell type + leiden in one iframe)
- Simplified layout for single combined visualization

#### Summary Heatmaps
- Updated to render HTML heatmaps in iframes instead of images
- Adjusted sizing and layout for iframe display

### 7. Missing Visualizations

The following visualizations from the old system are not generated by the new pipeline:
- `cluster_by_cell_type_heatmap.png` - Shows "No image found"

All other visualizations have HTML equivalents with enhanced interactivity.

## Testing Checklist

- [ ] Node selection loads correctly
- [ ] Summary heatmaps display in iframes
- [ ] Program labels use correct 1-based indexing
- [ ] Per-program UMAPs load in iframes
- [ ] Per-program breakdowns display combined cell type + leiden charts
- [ ] Missing files show "No image found" message gracefully
- [ ] Cell type UMAP (interactive) loads correctly
- [ ] Program correlation heatmap (if exists) displays

## Benefits of New System

1. **Interactive Visualizations**: All plots are now Plotly-based with zoom, pan, and hover capabilities
2. **Consistent Styling**: All visualizations use the same plotting library and styling
3. **Better Data Display**: Hover tooltips show exact values
4. **Cell Type Filtering**: Rare cell types (<1% of cells) are automatically filtered
5. **1-based Indexing**: More intuitive for users (Program 1, 2, 3 instead of 0, 1, 2)

## Known Issues

1. `cluster_by_cell_type_heatmap` is not generated - displays "No image found"
2. Some old PNG image paths may still be referenced in cached data - clear browser cache if issues occur

## Future Improvements

- Consider adding `cluster_by_cell_type_heatmap` generation to `c3po_display`
- Add loading indicators for iframes
- Implement progressive loading for large datasets
- Add download buttons for individual plots

